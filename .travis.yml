language: node_js
node_js:
  - "14"
script:
  - PROJECT_ROOT_PATH="$(pwd)"
  # Classical test workflow
  - npm run build
  - npm run test
  # Checking the bundle against commonjs and esm configurations
  ## Instead of linking on ., we pack the package as if it was released on npm registry
  ## then we link towards this version (no devDependencies installed, no unpublished files available...).
  - cd "$PROJECT_ROOT_PATH"
  - npm pack && mkdir -p bundle && tar -C bundle -zxvf jest-fast-check-*.tgz
  - rm -rf node_modules/
  ## CommonJS
  - cd "$PROJECT_ROOT_PATH"
  - cd test-bundle/commonjs && yarn && yarn test
  ## ESM - More on ESM + Jest at https://github.com/facebook/jest/issues/9430
  - cd "$PROJECT_ROOT_PATH"
  - cd test-bundle/esm && yarn && yarn test
  ## Cleaning for deploy
  - cd "$PROJECT_ROOT_PATH"
deploy:
  provider: npm
  email: npm@dubien.org
  skip_cleanup: true
  api_key:
    secure: Yw8bXHgvkJotliO/YuA7E9ILiwwcYk1QD7fKzuHsVkLxZVfzKlR30eyC7S2nj/smOp5KkZK74KT6kJm34bxGfTXPhFmAS5AwE/7EFt1K26BTtxiMSMLUb7CYSmqVmRopht0+s7DjdUbAOSUHCqCc0M/6gs66GIvlNwJYiF6qoW5yGHXIVlkSiXrbbslQJVUzqlxq5KVpOnVQkt9Ragyui/xQIlIuKgUyei/h1CBh78qTsaez/xrMbupNoqvh7i2IOAyn4yzbZOGw8w0W1MpqKR/YoYz9turuYDct+UKtHAWYILOHHHWK/nf5356RxWAq+4XnScvhCfDpfs1t1fIjUOyzh9Vmjir/M/1BBMbyNqEpNbJ6a98Ou0Akvt0wVH5hn1hWVUDzj1unU9MHnNBo7iw8CnC3zw2HV9396Kru4bvKN5zfqwLOned4SoDB76tDzWMnG2Jx+wMdJWeuI0T8Qv0lQglsoDUvI9vgTQJDMrI587b0MBW6q1EpHrGEIffl8jlcJd2dNnDCrwcY0BJ26pGnao+Y9rMUd4XMEsu2fweSdXmamtncz8+jljnnoyKpNchg3Zke5NNdzod9UgfknldpWIljkb495ZDAhFPrevSEMRInV/igXBobugd0EsyXVff1Ch5pqtsN/puKBhbbCxgZ/1SU8nRBnzG+sq6nV3U=
  on:
    tags: true
    repo: dubzzz/jest-fast-check
