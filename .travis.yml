language: node_js
node_js:
  - "14"
script:
  - PROJECT_ROOT_PATH="$(pwd)"
  # Classical test workflow
  - npm run build
  - npm run test
  # Checking the bundle against commonjs and esm configurations
  ## Instead of linking on ., we pack the package as if it was released on npm registry
  ## then we link towards this version (no devDependencies installed, no unpublished files available...).
  - cd "$PROJECT_ROOT_PATH"
  - npm pack && mkdir -p bundle && tar -C bundle -zxvf jest-fast-check-*.tgz
  - rm -rf node_modules/
  ## CommonJS
  - cd "$PROJECT_ROOT_PATH"
  - cd test-bundle/commonjs && yarn && yarn test
  ## ESM - More on ESM + Jest at https://github.com/facebook/jest/issues/9430
  - cd "$PROJECT_ROOT_PATH"
  - cd test-bundle/esm && yarn && yarn test
  ## Cleaning for deploy
  - cd "$PROJECT_ROOT_PATH"
deploy:
  provider: npm
  email: npm@dubien.org
  skip_cleanup: true
  api_key:
    secure: it4Fdz9Ez1EUAK50fJ+p0Y1rLkDcUQAOYk3xzZxG5KKJDuSVOzkR7aHdWjYhtlTGBBLMTjnuGme1A3XYKhIgoHOF5MVYSQoweFMYNMKFETUM4KX7awfepGp1mZVxaN+cBPfmcwyeSpwEXBk/e/mxemqJe2G8WedsI+uTdoN0tJrR096BX0GaASssIKbDGREYXedtYYyn0k//FEy3Q5IZLzoXNkTBG3t5fuQEhFbt2UM0gARh02f+Y9awPrA2zpj4yU/DEOEmjxqcQ14l12C4V7PN4aQpERc2slm8eg4y+7v0xMu3EzlmoAzWOddydg/TIP8rlxwCzylvzJX40hF+Yif6ywgPOyib/DMO/U6s96FTydHzqPGTRg9/Xc7X3OkW+SOxue7kz4X92lLYgEM1d1gTCPSFk+ynMVNnCnA5OQMNKaMn1I4gF5tVrDgP+Tumwev+ccHl0YquSQe5qgEDlhuT/ibE+F2R1mpXS4p1bw8PMmrjuqOs+DgH12sKSm0TdB7EpXnzWq9HGFq9ECjQuCIqNA5rzwWhR1JsxHGqHmxXQu6ftrw0dpi8WT6eXS6T6vQzgzrR5FFOyKmeME6MgbwW93qJMUbAqP+DJz8TjLoohnGuKxluRdfOx2TAHZ/ORP7M0biKKIzeVudF7mJiISm7j8PwmvgXyrVxqEpNIUw=
  on:
    tags: true
    repo: dubzzz/jest-fast-check
